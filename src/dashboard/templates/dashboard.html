<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WIDS Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        /* ... (Keep previous CSS styles) ... */
        body { padding-top: 1rem; padding-bottom: 1rem; }
        .table-responsive { max-height: 60vh; overflow-y: auto; }
        #eventDetailsModal .modal-body pre { max-height: 200px; overflow-y: auto; background-color: #343a40; padding: 10px; border-radius: 5px; color: #f8f9fa; }
        .status-indicator { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-normal { background-color: #28a745; } .status-anomaly { background-color: #dc3545; }
        .status-unlabeled { background-color: #ffc107; } .status-labeled { background-color: #17a2b8; }
        .spinner-container { display: flex; justify-content: center; align-items: center; min-height: 200px; }
        html, body { height: 100%; } body { display: flex; flex-direction: column; } main { flex: 1 0 auto; } footer { flex-shrink: 0; }
    </style>
</head>
<body>
    <main class="container">
        <header class="d-flex justify-content-between align-items-center mb-4 pb-3 border-bottom">
            <h1 class="h3"><i class="bi bi-wifi"></i> WIDS Dashboard</h1>
            <div>
                <span id="apiStatus" class="text-muted small me-3">Connecting...</span>
                {# Use user info passed from FastAPI context #}
                {% if user %}
                <span class="text-muted small me-2">User: {{ user.username }}</span>
                <a href="/logout" class="btn btn-sm btn-outline-secondary"><i class="bi bi-box-arrow-right"></i> Logout</a>
                {% endif %}
            </div>
        </header>

        <section class="row mb-3 g-3 align-items-center">
             <div class="col-md-auto"> <button id="refreshButton" class="btn btn-primary"><i class="bi bi-arrow-clockwise"></i> Refresh</button> </div>
             <div class="col-md-auto"> <div class="form-check form-switch"> <input class="form-check-input" type="checkbox" role="switch" id="unlabeledOnlySwitch" checked> <label class="form-check-label" for="unlabeledOnlySwitch">Unlabeled Only</label> </div> </div>
             <div class="col-md-3"> <select class="form-select form-select-sm" id="limitSelect"> <option value="50">50</option> <option value="100" selected>100</option> <option value="250">250</option> <option value="500">500</option> </select> </div>
             <div class="col-md-auto ms-md-auto text-md-end"> <span id="eventCount" class="text-muted small">Total: 0 | Showing: 0</span> </div>
        </section>

        <div id="loadingIndicator" class="spinner-container d-none"> <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div> </div>
        <div id="errorDisplay" class="alert alert-danger d-none" role="alert"></div>
        <section id="eventsTableSection" class="table-responsive mb-4">
            <table class="table table-hover table-sm caption-top">
                <caption>Logged Events</caption>
                <thead class="table-light"> <tr> <th scope="col">Timestamp</th> <th scope="col">UID</th> <th scope="col">Prediction</th> <th scope="col">Label</th> <th scope="col">Status</th> <th scope="col">Actions</th> </tr> </thead>
                <tbody id="eventsTableBody"><tr><td colspan="6" class="text-center text-muted">No events loaded yet.</td></tr></tbody>
            </table>
        </section>

        <div class="modal fade" id="eventDetailsModal" tabindex="-1"> /* ... */ </div>

    </main>
    <footer class="container mt-auto py-3 text-center text-muted border-top"> <small>WIDS Dashboard &copy; 2025</small> </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- Configuration ---
        // Get the backend API URL from the context passed by FastAPI/Jinja2
        const WIDS_API_BASE_URL = "{{ wids_api_base_url }}"; // Use Jinja2 variable
        const EVENTS_ENDPOINT = `${WIDS_API_BASE_URL}/events/`;
        const LABEL_ENDPOINT = `${WIDS_API_BASE_URL}/events/label`;

        console.log("WIDS API Target:", WIDS_API_BASE_URL); // Debug: Check if URL is passed correctly

        // --- DOM Elements (Keep same as before) ---
        const eventsTableBody = document.getElementById('eventsTableBody'); const loadingIndicator = document.getElementById('loadingIndicator'); const errorDisplay = document.getElementById('errorDisplay');
        const refreshButton = document.getElementById('refreshButton'); const unlabeledOnlySwitch = document.getElementById('unlabeledOnlySwitch'); const limitSelect = document.getElementById('limitSelect');
        const eventCountSpan = document.getElementById('eventCount'); const apiStatusSpan = document.getElementById('apiStatus'); const eventDetailsModalEl = document.getElementById('eventDetailsModal');
        const eventDetailsModal = new bootstrap.Modal(eventDetailsModalEl); const modalEventUid = document.getElementById('modalEventUid'); const modalTimestamp = document.getElementById('modalTimestamp');
        const modalPrediction = document.getElementById('modalPrediction'); const modalCurrentLabel = document.getElementById('modalCurrentLabel'); const modalLabelTimestamp = document.getElementById('modalLabelTimestamp');
        const modalFeaturesData = document.getElementById('modalFeaturesData'); const labelForm = document.getElementById('labelForm'); const labelEventUidInput = document.getElementById('labelEventUidInput');
        const labelSubmitStatus = document.getElementById('labelSubmitStatus'); const submitLabelButton = document.getElementById('submitLabelButton'); const submitLabelSpinner = submitLabelButton.querySelector('.spinner-border');
        let currentEventsData = [];

        // --- Functions (Keep showLoading, showError, hideError, formatTimestamp, renderTable, fetchEvents, showDetails, handleLabelSubmit same as before) ---
        // Ensure fetchEvents uses the correct EVENTS_ENDPOINT constant defined above
        // Ensure handleLabelSubmit uses the correct LABEL_ENDPOINT constant defined above
        function showLoading(isLoading) { loadingIndicator.classList.toggle('d-none', !isLoading); refreshButton.disabled = isLoading; unlabeledOnlySwitch.disabled = isLoading; limitSelect.disabled = isLoading; }
        function showError(message) { errorDisplay.textContent = message; errorDisplay.classList.remove('d-none'); apiStatusSpan.textContent = 'Error'; apiStatusSpan.className = 'text-danger small'; }
        function hideError() { errorDisplay.classList.add('d-none'); }
        function formatTimestamp(isoString) { if (!isoString) return 'N/A'; try { return new Date(isoString).toISOString().replace('T', ' ').substring(0, 19); } catch (e) { console.error("Date format error:", isoString, e); return 'Invalid Date'; } }
        function renderTable(events) { eventsTableBody.innerHTML = ''; if (!events || events.length === 0) { eventsTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No events found.</td></tr>'; return; } events.forEach(event => { const row = eventsTableBody.insertRow(); const pT = event.prediction === 1 ? 'Anomaly' : (event.prediction === 0 ? 'Normal' : 'Unk'); const lT = event.human_label || 'None'; const lS = event.human_label ? 'Labeled' : 'Unlabeled'; const lSC = event.human_label ? 'status-labeled' : 'status-unlabeled'; const pSC = event.prediction === 1 ? 'status-anomaly' : 'status-normal'; row.innerHTML = `<td>${formatTimestamp(event.timestamp)}</td><td>${event.event_uid}</td><td><span class="status-indicator ${pSC}"></span> ${pT}</td><td>${lT}</td><td><span class="status-indicator ${lSC}"></span> ${lS}</td><td><button class="btn btn-sm btn-outline-info" data-uid="${event.event_uid}" onclick="showDetails('${event.event_uid}')"><i class="bi bi-info-circle"></i> Details</button></td>`; }); }
        async function fetchEvents() { showLoading(true); hideError(); apiStatusSpan.textContent = 'Fetching...'; apiStatusSpan.className = 'text-warning small'; const limit = limitSelect.value; const unlabeledOnly = unlabeledOnlySwitch.checked; const params = new URLSearchParams({ skip: 0, limit: limit, unlabeled_only: unlabeledOnly.toString() }); try { const response = await fetch(`${EVENTS_ENDPOINT}?${params.toString()}`, { method: 'GET', headers: { 'Accept': 'application/json' } }); if (!response.ok) { const errorText = await response.text(); throw new Error(`API Error ${response.status}: ${errorText}`); } const data = await response.json(); currentEventsData = data.events || []; renderTable(currentEventsData); eventCountSpan.textContent = `Total: ${data.total_count || 0} | Showing: ${currentEventsData.length}`; apiStatusSpan.textContent = 'Connected'; apiStatusSpan.className = 'text-success small'; } catch (error) { console.error("Fetch error:", error); showError(`Fetch events failed: ${error.message}`); renderTable([]); eventCountSpan.textContent = 'Total: - | Showing: -'; } finally { showLoading(false); } }
        function showDetails(eventUid) { const event = currentEventsData.find(e => e.event_uid === eventUid); if (!event) { showError(`Details not found: ${eventUid}`); return; } modalEventUid.textContent = event.event_uid; modalTimestamp.textContent = formatTimestamp(event.timestamp); modalPrediction.textContent = event.prediction === 1 ? 'Anomaly' : (event.prediction === 0 ? 'Normal' : 'Unk'); modalCurrentLabel.textContent = event.human_label || 'None'; modalLabelTimestamp.textContent = formatTimestamp(event.label_timestamp); try { modalFeaturesData.textContent = JSON.stringify(event.features_data, null, 2); } catch (e) { modalFeaturesData.textContent = "Error displaying features."; } labelEventUidInput.value = event.event_uid; labelSubmitStatus.textContent = ''; labelSubmitStatus.className = 'mt-2'; submitLabelButton.disabled = false; submitLabelSpinner.classList.add('d-none'); eventDetailsModal.show(); }
        async function handleLabelSubmit(event) { event.preventDefault(); labelSubmitStatus.textContent = ''; submitLabelButton.disabled = true; submitLabelSpinner.classList.remove('d-none'); const eventUid = labelEventUidInput.value; const selectedLabel = labelForm.querySelector('input[name="humanLabelRadio"]:checked').value; if (!eventUid || !selectedLabel) { labelSubmitStatus.textContent = 'Error: Missing data.'; labelSubmitStatus.className = 'mt-2 text-danger small'; submitLabelButton.disabled = false; submitLabelSpinner.classList.add('d-none'); return; } const payload = { event_uid: eventUid, human_label: selectedLabel }; try { const response = await fetch(LABEL_ENDPOINT, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' }, body: JSON.stringify(payload) }); const result = await response.json(); if (!response.ok) { const errorDetail = result.detail || `API Error ${response.status}`; throw new Error(errorDetail); } labelSubmitStatus.textContent = `Labeled as '${selectedLabel}'.`; labelSubmitStatus.className = 'mt-2 text-success small'; setTimeout(() => { eventDetailsModal.hide(); fetchEvents(); }, 1500); } catch (error) { console.error("Label submit error:", error); labelSubmitStatus.textContent = `Error: ${error.message}`; labelSubmitStatus.className = 'mt-2 text-danger small'; submitLabelButton.disabled = false; submitLabelSpinner.classList.add('d-none'); } }

        // --- Event Listeners ---
        refreshButton.addEventListener('click', fetchEvents); unlabeledOnlySwitch.addEventListener('change', fetchEvents); limitSelect.addEventListener('change', fetchEvents); labelForm.addEventListener('submit', handleLabelSubmit);
        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', fetchEvents);
    </script>
</body>
</html>
